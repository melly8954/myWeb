<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.melly.myweb.board.free.IBoardFreeMybatisMapper">

    <!-- 게시글 등록 -->
    <insert id="insert" parameterType="BoardFreeDto" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO board_free_tbl( title
                                    , content
                                    , createId)
        VALUES { #{title}
                ,#{content}
                ,#{createId}
    </insert>


    <!-- 게시글 수정 -->
    <update id="update" parameterType="Long">
        UPDATE board_free_tbl
        SET title = #{title}
            , content = #{content}
            , updateDt = #{updateDt}
        WHERE id = #{id}
    </update>


    <!-- 게시글 삭제 -->
    <delete id="delete" parameterType="Long">
        UPDATE board_free_tbl
        SET deleteYn = TRUE
        WHERE id = #{id}
    </delete>


    <!-- 게시글 상세정보 조회 -->
    <select id="findById" parameterType="Long" resultType="BoardFreeDto">
        SELECT bt.id
            , bt.title
            , bt.content
            , bt.viewQty
            , bt.likeQty
            , bt.createId
            , bt.createDt
            , bt.updateDt
            , bt.deleteYn
            , ut.nickname As createName

        FROM board_free_tbl AS bt
        LEFT JOIN user_tbl ut on bt.createId = ut.id
        WHERE bt.id = #{id}
        AND bt.deleteYn = false
    </select>


    <!-- 게시글 리스트 & 해당 글에 달린 댓글 개수 조회 -->
    <select id="findAllByNameContains" parameterType="SearchBoardDto" resultType="BoardFreeDto">
        SELECT bt.id
            , bt.title
            , (SELECT count(*)
               FROM board_comment_tbl
               WHERE tbl='free' AND boardId = bt.id AND deleteYn=false) As countComment
            , bt.content
            , bt.viewQty
            , bt.likeQty
            , bt.createId
            , bt.createDt
            , bt.updateDt
            , bt.deleteYn
            , ut.nickname As createName
        FROM board_free_tbl AS bt
        LEFT JOIN user_tbl AS ut ON bt.createId = ut.id
        WHERE bt.deleteYn = false
            AND ${searchType} Like CONCAT('%',#{searchName},'%')
        ORDER BY ${orderByWord}
        LIMIT #{rowsOnePage} OFFSET #{firstIndex}
    </select>


    <!-- 게시글 카운트 -->
    <select id="countAllByNameContains" parameterType="SearchBoardDto" resultType="Integer">
        SELECT COUNT(*)
        FROM board_free_tbl AS bt
        LEFT JOIN user_tbl AS ut ON bt.createId = ut.id
        WHERE bt.deleteYn = false
        AND ${searchType} Like CONCAT('%',#{searchName},'%')
    </select>


    <!-- 조회수 증가 -->
    <update id="addViewQty" parameterType="Long">
        UPDATE board_free_tbl
        SET viewQty = viewQty + 1
        WHERE id = #{id}
        AND deleteYn = false
    </update>


    <!-- 좋아요 누를 경우 -->
    <update id="addLikeQty">
        UPDATE board_free_tbl
        SET likeQty = likeQty + 1
        WHERE id = #{id}
        AND deleteYn = false
    </update>


    <!-- 좋아요 제거 할 경우 -->
    <update id="subLikeQty">
        UPDATE board_free_tbl
        SET likeQty = likeQty + 1
        WHERE id = #{id}
        AND deleteYn = false
    </update>

</mapper>

